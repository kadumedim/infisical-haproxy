global
  maxconn 10000
  log stdout format raw local0

defaults
  log global
  mode http
  option httplog
  option forwardfor
  timeout connect 10s
  timeout client  30m
  timeout server  30m
  timeout check   5s
  http-request set-header X-Forwarded-Proto https if { ssl_fc }

resolvers railway
  parse-resolv-conf
  resolve_retries 3
  timeout resolve 1s
  timeout retry   1s
  hold valid      10s

listen stats
  bind *:${STATS_PORT}
  mode http
  stats enable
  stats uri /stats
  stats refresh 10s
  stats auth admin:${STATS_PASSWORD}

frontend infisical_frontend
  bind *:${BIND_PORT}
  mode http
  default_backend infisical_backend

backend infisical_backend
  mode http
  option httpchk GET /api/status
  http-check expect status 200
  balance roundrobin
  default-server inter 2s fall 3 rise 2 on-marked-down shutdown-sessions resolvers railway resolve-prefer ${RESOLVE_PREFER} init-addr last,libc,none
  server infisical1 ${INFISICAL1_HOST}:${INFISICAL_PORT} check
  server infisical2 ${INFISICAL2_HOST}:${INFISICAL_PORT} check
  server infisical3 ${INFISICAL3_HOST}:${INFISICAL_PORT} check
